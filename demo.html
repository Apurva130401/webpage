<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Demo - SyncFlo Ai</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0B0F19', secondary: '#141A28', accent: '#00F0FF', accent2: '#7000FF', muted: '#8A8F98',
                        green_accent: '#00FF87', linkedin_blue: '#0A66C2', sales_orange: '#FF8C00', sales_red: '#FF4500',
                        // Updated WhatsApp-inspired colors
                        whatsapp_user_bg: '#E7FFDB', // Light mint green for user
                        whatsapp_ai_bg: '#FFFFFF',   // White for AI/contact
                        whatsapp_text: '#0c0c0d',    // Dark text for both
                        whatsapp_bg: '#E5DDD5'       // Chat background color
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body, html { background-color: #0B0F19; color: white; font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .gradient-text { background: linear-gradient(90deg, #00F0FF, #7000FF); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .hero-pattern { background-image: radial-gradient(circle at 10% 20%, rgba(0, 240, 255, 0.05) 0%, transparent 25%), radial-gradient(circle at 90% 80%, rgba(112, 0, 255, 0.05) 0%, transparent 25%); }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- MODIFIED STYLES --- */
        /* Base button style remains unchanged */
        .demo-button {
             transition: all 0.3s ease;
        }

        /* Active state for WhatsApp AI Button */
        /* Colors from WhatsApp Business AI card in Index.html */
        .demo-button.active[data-demo="whatsapp"] {
            background: linear-gradient(90deg, #00FF87, #00A3FF);
            color: #0B0F19; /* Dark text for contrast */
        }

        /* Active state for AI Voice Agent Button */
        /* Colors from AI Voice Sales Agent card in Index.html */
        .demo-button.active[data-demo="voice"] {
            background: linear-gradient(90deg, #FF8C00, #FF4500);
            color: white; /* White text for contrast */
        }

        /* Active state for LinkedIn AI Button */
        /* Colors from LinkedIn AI Automation card in Index.html */
        .demo-button.active[data-demo="linkedin"] {
            background: linear-gradient(90deg, #0A66C2, #00F0FF);
            color: #0B0F19; /* Dark text for contrast */
        }
        /* --- END OF MODIFICATIONS --- */

        /* Chatbot Styles */
        #chat-bubble {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 4rem;
            height: 4rem;
            background: linear-gradient(90deg, #00F0FF, #7000FF);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
            transition: transform 0.3s ease;
        }
        #chat-bubble:hover {
            transform: scale(1.1);
        }
        #chat-window {
            position: fixed;
            bottom: 7rem;
            right: 2rem;
            width: 90%;
            max-width: 400px;
            height: 70vh;
            max-height: 600px;
            background-color: #141A28;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
        }
        #chat-window.open {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .user-message {
            background: linear-gradient(90deg, #00F0FF, #7000FF);
            color: #0B0F19;
            align-self: flex-end;
        }
        .ai-message {
            background-color: #2A3142;
            color: white;
            align-self: flex-start;
        }
        .ai-message a {
            color: #00F0FF;
            text-decoration: underline;
            font-weight: bold;
        }
        .ai-message a:hover {
            color: #7000FF;
        }
        .chat-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            align-self: flex-start;
        }
        .chat-button {
            background-color: #2A3142;
            border: 1px solid #00F0FF;
            color: #00F0FF;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .chat-button:hover {
            background-color: #00F0FF;
            color: #141A28;
        }

    </style>
</head>
<body class="hero-pattern">
    <nav class="fixed w-full z-50 bg-primary/80 backdrop-blur-lg border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center"><div class="text-3xl font-bold font-display"><span class="gradient-text">SyncFlo</span><span class="text-white">Ai</span></div></a>
            <a href="CalendarBook.html" class="bg-gradient-to-r from-accent to-accent2 text-primary font-semibold px-6 py-2 rounded-full hover:opacity-90 transition-opacity">Request for live Demo</a>
        </div>
    </nav>

    <main class="pt-32 pb-20 container mx-auto px-6">
        <section class="text-center">
            <h1 class="text-4xl md:text-6xl font-bold font-display leading-tight">See Your <span class="gradient-text">AI Agent</span> in Action</h1>
            <p class="text-xl text-white/80 mt-6 max-w-3xl mx-auto">Choose a scenario below to see how our AI can handle real-world business tasks, automate conversations, and drive growth 24/7.</p>
        </section>

        <section class="mt-16">
            <div class="flex justify-center items-center space-x-2 md:space-x-4 mb-8" id="demo-controls">
                <button data-demo="whatsapp" class="demo-button active font-semibold px-4 py-2 md:px-6 md:py-3 rounded-full bg-secondary hover:bg-white/20">WhatsApp AI</button>
                <button data-demo="voice" class="demo-button font-semibold px-4 py-2 md:px-6 md:py-3 rounded-full bg-secondary hover:bg-white/20">AI Voice Agent</button>
                
            </div>

            <div class="max-w-md mx-auto bg-secondary rounded-2xl border border-white/10 p-4 shadow-2xl shadow-accent/10">
                <div id="demo-whatsapp" class="demo-content">
                    <div class="bg-whatsapp_bg rounded-xl p-4 h-[550px] flex flex-col">
                        <div class="flex items-center mb-4 pb-2 border-b border-black/10">
                            <div class="w-10 h-10 rounded-full bg-green_accent flex items-center justify-center text-primary font-bold mr-3">S</div>
                            <div>
                                <h4 class="font-bold text-black">SyncFlo Agent</h4>
                                <p class="text-xs text-gray-600">Online</p>
                            </div>
                        </div>
                        <div id="whatsapp-chat" class="flex-grow flex flex-col space-y-2 overflow-y-auto pr-2">
                            </div>
                    </div>
                    <button data-demo="whatsapp" class="replay-button block w-full mt-3 py-2 rounded-md text-center text-muted hover:text-white hover:bg-white/10 transition-colors">
                        <svg class="w-5 h-5 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 009.828 3.721M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Replay
                    </button>
                </div>
                <div id="demo-voice" class="demo-content hidden">
                     <div class="bg-primary rounded-xl p-4 h-[550px] flex flex-col">
                        <div class="text-center p-4"><h4 class="font-bold text-xl">Inbound Call</h4><p class="text-muted">TechCorp Industries</p><p id="call-timer" class="font-mono text-accent mt-2">00:00</p></div>
                        <div id="voice-transcript" class="flex-grow space-y-3 overflow-y-auto p-3 text-sm border-t border-white/10"></div>
                    </div>
                    <button data-demo="voice" class="replay-button block w-full mt-3 py-2 rounded-md text-center text-muted hover:text-white hover:bg-white/10 transition-colors"><svg class="w-5 h-5 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 009.828 3.721M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Replay</button>
                </div>
                <div id="demo-linkedin" class="demo-content hidden">
                    <div class="bg-primary rounded-xl p-4 h-[550px] flex flex-col">
                        <div class="flex items-center p-2 mb-2 border-b border-white/10"><svg class="w-6 h-6 text-linkedin_blue mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.065 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg><h4 class="font-bold">LinkedIn Automation</h4></div>
                        <div id="linkedin-feed" class="flex-grow space-y-4 overflow-y-auto p-2 text-sm"></div>
                    </div>
                    <button data-demo="linkedin" class="replay-button block w-full mt-3 py-2 rounded-md text-center text-muted hover:text-white hover:bg-white/10 transition-colors"><svg class="w-5 h-5 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 009.828 3.721M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Replay</button>
                </div>
            </div>
        </section>
    </main>
	<vapi-widget
  public-key="4394e71a-0251-4e9b-a3f4-c3932725fde4"
  assistant-id="d29a31d1-6bc5-4c20-99c3-d3fba7764dc5"
  mode="voice"
  theme="dark"
  base-bg-color="#000000"
  accent-color="#14B8A6"
  cta-button-color="#000000"
  cta-button-text-color="#ffffff"
  border-radius="large"
  size="full"
  position="bottom-right"
  title="TALK WITH NINA"
  start-button-text="Start"
  end-button-text="End Call"
  chat-first-message="Hey, How can I help you today?"
  chat-placeholder="Type your message..."
  voice-show-transcript="true"
  consent-required="false"
></vapi-widget>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Demo data
    const whatsappScript = [
        { from: 'user', text: "Hi, I saw your ad on Instagram. Can you tell me more about the 'Growth' plan?" },
        { from: 'ai', text: "Of course! The Growth plan is our most popular package. It includes 5 AI agents, 5,000 leads per month, and premium integrations like Salesforce. What specific information are you looking for?" },
        { from: 'user', text: "What's the price?" },
        { from: 'ai', text: "The Growth plan is $199 per month. We also offer a 15% discount for annual billing, bringing it down to about $169 per month." },
        { from: 'user', text: "That sounds good. Can I book a demo call?" },
        { from: 'ai', text: "Absolutely. I can book that for you right now. I have openings tomorrow at 10:00 AM or 2:00 PM IST. Which time works best for you?" },
        { from: 'user', text: "10am is perfect." },
        { from: 'ai', text: "Excellent. I have scheduled a demo for you tomorrow at 10:00 AM IST. You will receive a calendar invitation shortly. Is there anything else I can help with today?" },
		{ from: 'user', text: "Could you send me the link on my e-mail ID as I mostly on my computer" },
		{ from: 'ai', text: "Sure, can you please tell me your E-mail ID?" },
		{ from: 'user', text: "my email id is John@synclo.xyz" },
		{ from: 'ai', text: "Perfect. You'll receive your calendar link in your E-mail ID. Anything else I can help you with?" },
    ];

    const voiceScript = [
        { from: 'ai', text: "Hello, thank you for calling SyncFlo Ai. My name is Nina. How can I assist you today?" },
        { from: 'user', text: "Hi Nina, I'd like to learn about your AI voice agent services." },
        { from: 'ai', text: "I can certainly help with that. Our AI Voice Agent can handle both inbound and outbound calls, qualify leads, and even book appointments directly into your calendar. Are you looking to automate for a sales team or for customer support?" },
        { from: 'user', text: "Primarily for sales lead qualification." },
        { from: 'ai', text: "Great. Our system can qualify leads based on your custom criteria and then either route the call to a live sales representative or book a follow-up meeting. Would you be interested in a 15-minute live demo to see it in action?" },
        { from: 'user', text: "Yes, that would be great." },
        { from: 'ai', text: "Perfect. What's the best email address to send the meeting invitation to?" },
		{ from: 'user', text: "It's user@techorp.xyz" },
		{ from: 'ai', text: "Okay, just to confirm, it's user@techorp.xyz, right" },
		{ from: 'user', text: "Yes" },
		{ from: 'ai', text: "Okay I'll send the email with all the details and the demo link will also be added into your calendar" },
		{ from: 'user', text: "Okay thank you" },
		{ from: 'ai', text: "Thanks for calling SyncFlo, hope you enjoy our services" }
    ];

    // DOM Elements
    const controls = document.getElementById('demo-controls');
    const demoContents = document.querySelectorAll('.demo-content');
    let activeDemo = 'whatsapp';

    const whatsappChatEl = document.getElementById('whatsapp-chat');
    const voiceTranscriptEl = document.getElementById('voice-transcript');
    const callTimerEl = document.getElementById('call-timer');

    let demoStates = { whatsapp: false, voice: false, linkedin: false };

    // Functions
    function typeWriter(element, text, onComplete) {
        let i = 0;
        element.innerHTML = '';
        const cursor = '<span class="blinking-cursor">|</span>';
        element.innerHTML = cursor;

        function typing() {
            if (i < text.length) {
                element.innerHTML = text.substring(0, i + 1) + cursor;
                i++;
                setTimeout(typing, 30);
            } else {
                element.innerHTML = text; // Remove cursor when done
                if(onComplete) onComplete();
            }
        }
        typing();
    }

    async function runWhatsappDemo() {
        if (demoStates.whatsapp) return;
        demoStates.whatsapp = true;
        whatsappChatEl.innerHTML = '';
        for (const msg of whatsappScript) {
            await new Promise(resolve => setTimeout(resolve, 800));
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `w-full flex ${msg.from === 'ai' ? 'justify-start' : 'justify-end'}`;
            const bubble = document.createElement('div');
            bubble.className = 'rounded-lg p-3 max-w-[80%] text-whatsapp_text shadow-md';
            bubble.classList.add(msg.from === 'ai' ? 'bg-whatsapp_ai_bg' : 'bg-whatsapp_user_bg');
            messageWrapper.appendChild(bubble);
            whatsappChatEl.appendChild(messageWrapper);
            await new Promise(resolve => typeWriter(bubble, msg.text, resolve));
            whatsappChatEl.scrollTop = whatsappChatEl.scrollHeight;
        }
        demoStates.whatsapp = false;
    }

    async function runVoiceDemo() {
        if (demoStates.voice) return;
        demoStates.voice = true;
        voiceTranscriptEl.innerHTML = '';
        if(window.voiceTimerInterval) clearInterval(window.voiceTimerInterval);
        callTimerEl.textContent = '00:00';
        
        let seconds = 0;
        window.voiceTimerInterval = setInterval(() => {
            seconds++;
            const min = Math.floor(seconds / 60).toString().padStart(2, '0');
            const sec = (seconds % 60).toString().padStart(2, '0');
            callTimerEl.textContent = `${min}:${sec}`;
        }, 1000);

        for (const msg of voiceScript) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            const line = document.createElement('div');
            line.className = `p-2 rounded-lg ${msg.from === 'ai' ? 'text-left' : 'text-right'}`;
            const speaker = document.createElement('span');
            speaker.className = `font-bold ${msg.from === 'ai' ? 'text-accent' : 'text-white'}`;
            speaker.textContent = msg.from === 'ai' ? 'Nina: ' : 'User: ';
            const content = document.createElement('span');
            line.appendChild(speaker);
            line.appendChild(content);
            voiceTranscriptEl.appendChild(line);
            await new Promise(resolve => typeWriter(content, msg.text, resolve));
            voiceTranscriptEl.scrollTop = voiceTranscriptEl.scrollHeight;
        }
        clearInterval(window.voiceTimerInterval);
        demoStates.voice = false;
    }

    function showDemo(demoId) {
        activeDemo = demoId;
        controls.querySelectorAll('button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.demo === demoId);
        });
        demoContents.forEach(content => {
            content.classList.toggle('hidden', content.id !== `demo-${demoId}`);
        });

        if (demoId === 'whatsapp') runWhatsappDemo();
        else if (demoId === 'voice') runVoiceDemo();
    }

    controls.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.demo) {
            showDemo(e.target.dataset.demo);
        }
    });

    const replayButtons = document.querySelectorAll('.replay-button');
    replayButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const targetButton = e.target.closest('button');
            if(targetButton) {
                const demoId = targetButton.dataset.demo;
                if (demoId === 'whatsapp') runWhatsappDemo();
                else if (demoId === 'voice') runVoiceDemo();
            }
        });
    });

    showDemo('whatsapp');
});

// --- Chatbot Scripts ---

const chatBubble = document.getElementById('chat-bubble');
const chatWindow = document.getElementById('chat-window');
const closeChat = document.getElementById('close-chat');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const generatePitchButton = document.getElementById('generate-pitch');

// IMPORTANT: Add your own Gemini API Key here
const apiKey = "AIzaSyDftfcS4AQNPYo3Q2joZmYikWB4vpO_SfI"; 

// --- Function Calling Setup ---

// 1. Define the tools (our JavaScript functions)
const tools = {
    redirectToCalendly(name, email) {
        const calendlyUrl = `https://calendly.com/syncfloai/30min?name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`;
        window.open(calendlyUrl, '_blank');
        return `Success! I have opened the Calendly booking page for ${name}.`;
    },
    displayButtons(buttons) {
         return `Displayed buttons: ${buttons.join(', ')}`;
    },
    openLink(url) {
        window.open(url, '_blank');
        return `Successfully opened ${url}`;
    }
};

// 2. Define the tools' schema for the AI
const toolDefinitions = [{
    "functionDeclarations": [{
        "name": "redirectToCalendly",
        "description": "After collecting the user's name and email, use this function to redirect them to the Calendly page to book a demo.",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "name": { "type": "STRING", "description": "The user's full name." },
                "email": { "type": "STRING", "description": "The user's email address." }
            },
            "required": ["name", "email"]
        }
    }, {
         "name": "displayButtons",
        "description": "Display clickable suggestion buttons to the user in the chat.",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "buttons": {
                    "type": "ARRAY",
                    "description": "An array of button labels to display.",
                    "items": { "type": "STRING" }
                }
            },
            "required": ["buttons"]
        }
    }, {
        "name": "openLink",
        "description": "Use this function to open any URL in a new browser tab.",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "url": { "type": "STRING", "description": "The full URL to open." }
            },
            "required": ["url"]
        }
    }]
}];

// 3. Define the initial prompt for the AI
let chatHistory = [{
    role: "user",
    parts: [{ text: "You are a fun, friendly and helpful Sales assistant for SyncFlo Ai. You are talking on behalf of SyncFlo and your goal is to answer questions about the company and its products (WhatsApp Automation, AI Voice Sales Agent). Your primary goal is to understand the user's needs and explain how SyncFlo's products can solve their problems. Only suggest a demo when it's a natural next step. If a user wants to book a demo, you MUST first ask them if they want a mock demo or a live demo by calling the `displayButtons` tool with the options 'Show me a mock demo' and 'Book a live demo'. If they choose live demo, you MUST use the `redirectToCalendly` tool after getting their name and email. If they choose mock demo, tell the user they can see it on our website and by calling the 'displayButtons' tool with options 'Go to Demo Page' and 'Go to Industry Page' and when the user clicks the 'Go to Demo Page' button, immediately use the 'openlink' tool and open 'https://syncflo.xyz/demo'. And If the user chooses 'Go to Industry Page', immediatley use the 'openlink' tool and open 'https://syncflo.xyz/whatsapp-industry'. If a user asks about pricing, tell them it starts at $99/month and then immediately use the `openLink` tool to show them the full details at 'https://syncflo.xyz/pricing.html'. Keep messages short. Do not make up information. Also the founder of SyncFlo AI is Apurva" }]
}, {
    role: "model",
    parts: [{ text: "Okay, I understand. My main goal is to be a helpful sales assistant, understand customer needs, and explain how our products can help. I will use my tools to provide demos and pricing information when appropriate. How can I help you today?" }]
}];


// --- Chat Logic ---

chatBubble.addEventListener('click', () => chatWindow.classList.toggle('open'));
closeChat.addEventListener('click', () => chatWindow.classList.remove('open'));

function addMessage(message, sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');

    if (sender === 'ai') {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const messageWithLinks = sanitizedMessage.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" class="font-bold underline">$1</a>');
        messageElement.innerHTML = messageWithLinks;
    } else {
        messageElement.textContent = message;
    }
    
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    const typingElement = document.createElement('div');
    typingElement.id = 'typing-indicator';
    typingElement.classList.add('chat-message', 'ai-message');
    typingElement.innerHTML = `<div class="flex items-center space-x-1"><span class="w-2 h-2 bg-white/50 rounded-full animate-pulse" style="animation-delay: 0s;"></span><span class="w-2 h-2 bg-white/50 rounded-full animate-pulse" style="animation-delay: 0.2s;"></span><span class="w-2 h-2 bg-white/50 rounded-full animate-pulse" style="animation-delay: 0.4s;"></span></div>`;
    chatMessages.appendChild(typingElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typingElement = document.getElementById('typing-indicator');
    if (typingElement) typingElement.remove();
}

async function handleAiResponse(response) {
    removeTypingIndicator();
    const candidate = response.candidates[0];

    if (!candidate || !candidate.content || !candidate.content.parts) {
        addMessage("Sorry, I received an invalid response. Please try again.", 'ai');
        return;
    }

    const modelResponsePart = { role: "model", parts: [] };
    let textResponse = null;
    let functionCall = null;

    candidate.content.parts.forEach(part => {
        if (part.text) {
            textResponse = part.text;
            modelResponsePart.parts.push({ text: textResponse });
        } else if (part.functionCall) {
            functionCall = part.functionCall;
            modelResponsePart.parts.push({ functionCall: functionCall });
        }
    });

    // Add the full model response to history first
    if (modelResponsePart.parts.length > 0) {
         chatHistory.push(modelResponsePart);
    }

    // Then, process the parts for the UI
    if (textResponse) {
        addMessage(textResponse, 'ai');
    }

    if (functionCall) {
        const functionName = functionCall.name;
        const functionArgs = functionCall.args;
        
        // Add the function's result to history so the AI knows what happened
        const functionResponse = {
            role: "function",
            parts: [{ functionResponse: { name: functionName, response: {} } }]
        };
        
        if (functionName === 'displayButtons') {
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'chat-buttons';
            functionArgs.buttons.forEach(label => {
                const button = document.createElement('button');
                button.className = 'chat-button';
                button.textContent = label;
                button.addEventListener('click', () => {
                    sendMessage(label);
                    buttonContainer.remove();
                });
                buttonContainer.appendChild(button);
            });
            chatMessages.appendChild(buttonContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            // We don't call the API again, we wait for the user click
        } else if (functionName === 'redirectToCalendly' || functionName === 'openLink') {
            const functionResult = tools[functionName](functionArgs.name || functionArgs.url, functionArgs.email);
            functionResponse.parts[0].functionResponse.response.content = functionResult;
            chatHistory.push(functionResponse);
            await callGeminiApi(); // Call again to get the confirmation text
        }
    }
}

async function callGeminiApi(prompt = null) {
    try {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        const currentHistory = prompt ? [...chatHistory, { role: 'user', parts: [{ text: prompt }] }] : chatHistory;

        const payload = { 
            contents: currentHistory,
            tools: toolDefinitions
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            console.error("API Error Body:", errorBody);
            throw new Error(`API request failed with status ${response.status}`);
        }
        
        const result = await response.json();
        await handleAiResponse(result);

    } catch (error) {
        console.error("Error calling Gemini API:", error);
        removeTypingIndicator();
        addMessage("Sorry, something went wrong. Please check your API key and the console for details.", 'ai');
    }
}

async function generateQuickPitch() {
    showTypingIndicator();
    const prompt = `Based on the conversation history and SyncFlo Ai's products (WhatsApp Automation and AI Voice Sales Agent), write a short, compelling sales pitch for a business. The pitch should be no more than 3 sentences. Do not use any placeholders like [Client Name] or [Your Company].`;
    
    // Clear history and add new prompt to get a fresh pitch
    const pitchHistory = [{
        role: "user",
        parts: [{ text: prompt }]
    }];

    try {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const payload = { 
            contents: pitchHistory
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            console.error("API Error Body:", errorBody);
            throw new Error(`API request failed with status ${response.status}`);
        }
        
        const result = await response.json();
        removeTypingIndicator();
        
        const generatedPitch = result.candidates[0].content.parts[0].text;
        addMessage(`✨ Here is a quick pitch for you: "${generatedPitch}"`, 'ai');

    } catch (error) {
        console.error("Error generating pitch:", error);
        removeTypingIndicator();
        addMessage("Sorry, I couldn't generate a pitch right now. Please try again.", 'ai');
    }
}

async function sendMessage(messageOverride = null) {
    const messageText = messageOverride || chatInput.value.trim();
    if (messageText === '') return;

    addMessage(messageText, 'user');
    if (!messageOverride) {
        chatInput.value = '';
    }
    showTypingIndicator();
    
    chatHistory.push({ role: "user", parts: [{ text: messageText }] });
    await callGeminiApi();
}

chatSend.addEventListener('click', () => sendMessage());
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

generatePitchButton.addEventListener('click', () => generateQuickPitch());

</script>

<!-- Chatbot HTML -->
<div id="chat-bubble">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.02-3.11A7.002 7.002 0 012 10c0-3.866, 3.582-7, 8-7s8, 3.134, 8, 7zM4.416, 14.65A6.986, 6.986, 0 0, 0, 10, 16c3.309, 0, 6-2.691, 6-6s-2.691-6-6-6-6, 2.691-6, 6c0, 1.562.602, 3.002, 1.626, 4.118L4.416, 14.65z" clip-rule="evenodd" />
    </svg>
</div>

<div id="chat-window" class="">
    <div class="p-4 bg-secondary border-b border-white/10 flex justify-between items-center">
        <h3 class="font-display font-bold text-lg"><span class="gradient-text">SyncFlo</span> Ai Assistant</h3>
        <button id="close-chat" class="text-white/70 hover:text-white">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto flex flex-col">
        <!-- Messages will be appended here -->
         <div class="chat-message ai-message">
            Hello! I'm your sales assistant. I can answer questions about SyncFlo Ai and our products. Try asking me to create a quick pitch for you!
        </div>
    </div>
    <div class="p-4 bg-secondary border-t border-white/10">
        <div class="flex items-center">
            <input type="text" id="chat-input" placeholder="Ask a question or type 'create pitch'..." class="flex-1 bg-primary border border-white/10 rounded-full py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-accent">
            <button id="chat-send" class="ml-3 p-2 bg-gradient-to-r from-accent to-accent2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            </button>
        </div>
         <button id="generate-pitch" class="w-full mt-3 bg-white/10 border border-white/20 text-white font-semibold px-8 py-2 rounded-full text-center hover:bg-white/20 transition-colors">
            ✨ Generate a Quick Pitch
        </button>
    </div>
</div>

<footer class="bg-secondary border-t border-white/10 py-12">
    <div class="container mx-auto px-6 text-center text-white/70">
        <div class="flex justify-center space-x-6 mb-6">
            <a href="data-processing.html" class="hover:text-accent transition-colors">Data Processing</a>
            <a href="terms.html" class="hover:text-accent transition-colors">Terms of Service</a>
            <a href="privacy-policy.html" class="hover:text-accent transition-colors">Privacy Policy</a>
            <a href="sitemap.xml" class="hover:text-accent transition-colors">Sitemap</a>
        </div>
        <p class="text-xs text-white/50">&copy; 2025 SyncFlo Ai. All Rights Reserved.</p>
    </div>
</footer>

</body>
</html>
